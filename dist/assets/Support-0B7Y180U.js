import{a as l,c as H,u as J,s as K,b as w,y as d,j as e}from"./index-CZcwaId7.js";import{g as W,h as g,i as f,e as Y,j as Z,k as ee,l as se,f as te,m as ae}from"./index-cFh8DywR.js";import{U as re,B as le}from"./UserLayout-BhLhJfUp.js";import"./iconBase-DWq9drA2.js";import"./index-CRrw9I0A.js";import"./index-CP5vjhFU.js";const pe=()=>{const[S,i]=l.useState([]),[j,T]=l.useState(!1),[a,o]=l.useState(null),[_,C]=l.useState(!1),[x,B]=l.useState(""),[b,F]=l.useState(!1),[ne,ce]=l.useState(!1),M=H(),N=l.useRef(null),m=J(),[L,D]=l.useState(""),[r,E]=l.useState({status:"",type:"",search:""}),[c,R]=l.useState({currentPage:1,totalPages:1,totalTickets:0,hasNext:!1,hasPrev:!1});l.useEffect(()=>{M(K(5))},[M]);const V=(s=1)=>{const t={page:s,limit:20};return r.status&&(t.status=r.status),r.type&&(t.type=r.type),r.search&&(t.search=r.search),t},u=l.useCallback(async(s=1)=>{T(!0);try{const t=V(s);console.log(t,"params");const n=await w.getAllSupportTickets(t);n.data.success?(i(n.data.tickets||[]),R(n.data.pagination||{currentPage:1,totalPages:1,totalTickets:0,hasNext:!1,hasPrev:!1})):(d.error(n.data.message||"Failed to fetch tickets"),i([]))}catch(t){console.error("Failed to fetch tickets:",t),i([])}finally{T(!1)}},[r.status,r.type,L]),A=l.useCallback(async s=>{if(s){C(!0);try{const t=await w.getTicketById(s);t.data.success?(o(t.data.ticket),i(n=>n.map(h=>h._id===s?t.data.ticket:h))):d.error(t.data.message||"Failed to load ticket details")}catch(t){console.error("Failed to fetch ticket details:",t),d.error(t.response?.data?.error||"Failed to load ticket details")}finally{C(!1)}}},[]);l.useEffect(()=>{u(1)},[r.status,r.type,u]),l.useEffect(()=>{const s=setTimeout(()=>{D(r.search)},1e3);return()=>clearTimeout(s)},[r.search]);const y=(s,t)=>{E(n=>({...n,[s]:t})),s==="search"&&o(null)},I=s=>{s.preventDefault()},q=async s=>{if(s.preventDefault(),!(!x.trim()||!a)){F(!0);try{const t=await w.addMessageToTicket(a._id,{message:x.trim()});t.data.success?(await A(a._id),B(""),d.success("Message sent successfully!"),setTimeout(()=>{N.current?.scrollIntoView({behavior:"smooth"})},100)):d.error(t.data.message||"Failed to send message")}catch(t){console.error("Failed to send message:",t),d.error(t.response?.data?.error||"Failed to send message")}finally{F(!1)}}},O=s=>{o(s),A(s._id)},Q=s=>{switch(s){case"open":return e.jsx(te,{className:"text-orange-500"});case"in-progress":return e.jsx(se,{className:"text-blue-500"});case"closed":return e.jsx(ee,{className:"text-green-500"});default:return e.jsx(g,{className:"text-gray-500"})}},P=s=>{switch(s){case"open":return"bg-orange-100 text-orange-800 border-orange-200";case"in-progress":return"bg-blue-100 text-blue-800 border-blue-200";case"closed":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},U=s=>{switch(s){case"User":return e.jsx(ae,{className:"text-purple-500"});case"Vendor":return e.jsx(FiShoppingBag,{className:"text-teal-500"});default:return e.jsx(f,{className:"text-gray-500"})}},X=s=>{switch(s){case"User":return"text-purple-600 bg-purple-50";case"Vendor":return"text-teal-600 bg-teal-50";default:return"text-gray-600 bg-gray-50"}},p=s=>s?new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",v=s=>s?typeof s=="string"?s:`${s.firstName||""} ${s.lastName||""}`.trim()||s.email||"Unknown User":"Unknown User",k=s=>!s||typeof s=="string"?"":s.email||"",z=s=>!s.messages||s.messages.length===0?s.createdAt:s.messages[s.messages.length-1].createdAt,$=s=>s.messages?s.messages.filter(t=>t.senderModel==="User"&&!t.isRead).length:0,G=s=>!s.messages||s.messages.length===0?"No messages":s.messages[s.messages.length-1].message||"No message content";return l.useEffect(()=>{a?.messages?.length&&N.current?.scrollIntoView({behavior:"smooth"})},[a?.messages]),e.jsx(re,{children:e.jsx("div",{className:"min-h-screen bg-white px-4 py-8 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"mx-auto max-w-7xl",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(le,{className:"text-4xl text-[#0b8263]"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-800",children:"Support Management"}),e.jsx("p",{className:"text-slate-600",children:"Manage and respond to user and vendor support tickets"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-[#0b8263]",children:c.totalTickets}),e.jsx("div",{className:"text-sm text-slate-500",children:"Total Tickets"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-4",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-2",children:[e.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-4 shadow-sm",children:e.jsxs("div",{className:"flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4",children:[e.jsx("form",{onSubmit:I,className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute top-1/2 left-3 -translate-y-1/2 transform text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search by subject or user...",value:r.search,onChange:s=>y("search",s.target.value),className:"w-full rounded-lg border border-slate-300 py-2 pr-4 pl-10 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none"})]})}),e.jsxs("select",{value:r.status,onChange:s=>y("status",s.target.value),className:"rounded-lg border border-slate-300 px-3 py-2 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in-progress",children:"In Progress"}),e.jsx("option",{value:"closed",children:"Closed"})]}),e.jsxs("select",{value:r.type,onChange:s=>y("type",s.target.value),className:"rounded-lg border border-slate-300 px-3 py-2 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"User",children:"User"}),e.jsx("option",{value:"Vendor",children:"Vendor"})]})]})}),e.jsx("div",{className:"space-y-3",children:j?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-b-2 border-[#0b8263]"}),e.jsx("p",{className:"mt-2 text-slate-600",children:"Loading tickets..."})]}):S.length===0?e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white py-12 text-center",children:[e.jsx(g,{className:"mx-auto mb-3 text-4xl text-slate-400"}),e.jsx("p",{className:"text-slate-600",children:"No tickets found"}),e.jsx("p",{className:"mt-1 text-sm text-slate-500",children:r.status||r.type||r.search?"Try changing your filters":"No support tickets yet"})]}):S.map(s=>e.jsx("div",{className:`cursor-pointer rounded-lg border bg-white p-4 shadow-sm transition-all hover:shadow-md ${a?._id===s._id?"border-[#0b8263] ring-2 ring-[#0b8263]":"border-slate-200"}`,onClick:()=>O(s),children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"mb-2 flex items-center space-x-2",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[Q(s.status),e.jsx("span",{className:`rounded-full border px-2 py-1 text-xs font-medium ${P(s.status)}`,children:s.status.replace("-"," ")})]}),e.jsxs("span",{className:`flex items-center space-x-1 rounded-full px-2 py-1 text-xs font-medium ${X(s.createdByModel)}`,children:[U(s.createdByModel),e.jsx("span",{children:s.createdByModel})]}),$(s)>0&&e.jsxs("span",{className:"rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800",children:[$(s)," new"]})]}),e.jsx("h3",{className:"mb-1 truncate font-semibold text-slate-800",children:s.subject}),e.jsx("p",{className:"text-xs text-gray-500",children:s.customSupportId}),e.jsxs("div",{className:"mb-2 flex items-center space-x-2 text-sm text-slate-600",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(f,{className:"text-slate-400"}),e.jsx("span",{onClick:t=>{t.stopPropagation(),s.createdByModel==="User"?m(`/user/${s.createdBy._id}`):m(`/vendor/${s.createdBy._id}`)},className:"hover:cursor-pointer hover:text-blue-500",children:v(s.createdBy)})]}),e.jsx("span",{children:"•"}),e.jsx("span",{children:k(s.createdBy)})]}),e.jsx("p",{className:"mb-2 line-clamp-2 text-sm text-slate-600",children:G(s)}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500",children:[e.jsxs("span",{children:[s.messages?.length||0," messages"]}),e.jsxs("span",{children:["Last: ",p(z(s))]})]})]})})},s._id))}),c.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-200 pt-4",children:[e.jsx("button",{onClick:()=>u(c.currentPage-1),disabled:!c.hasPrev||j,className:"rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 disabled:opacity-50",children:"Previous"}),e.jsxs("span",{className:"text-sm text-slate-600",children:["Page ",c.currentPage," of ",c.totalPages]}),e.jsx("button",{onClick:()=>u(c.currentPage+1),disabled:!c.hasNext||j,className:"rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 disabled:opacity-50",children:"Next"})]})]}),e.jsx("div",{className:"lg:col-span-2",children:_?e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-8 text-center shadow-sm",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-b-2 border-[#0b8263]"}),e.jsx("p",{className:"mt-4 text-slate-600",children:"Loading ticket details..."})]}):a?e.jsxs("div",{className:"sticky top-4 flex h-[calc(100vh-8rem)] flex-col rounded-lg border border-slate-200 bg-white shadow-sm",children:[e.jsx("div",{className:"border-b border-slate-200 p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800",children:a.subject}),e.jsx("span",{className:`rounded-full border px-2 py-1 text-xs font-medium ${P(a.status)}`,children:a.status.replace("-"," ")})]}),e.jsxs("div",{className:"mt-2 flex items-center space-x-4 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[U(a.createdByModel),e.jsxs("span",{children:[a.createdByModel," Ticket"]})]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Created: ",p(a.createdAt)]}),a.closedAt&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Closed: ",p(a.closedAt)]})]})]}),e.jsx("div",{className:"mt-2 flex items-center space-x-2 text-sm",children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(f,{className:"text-slate-400"}),e.jsx("span",{className:"font-medium text-slate-700 hover:cursor-pointer",onClick:s=>{s.stopPropagation(),a.createdByModel==="User"?m(`/user/${a.createdBy._id}`):m(`/vendor/${a.createdBy._id}`)},children:v(a.createdBy)}),e.jsxs("span",{className:"text-slate-500",children:["(",k(a.createdBy),")"]})]})}),a.assignedTo&&e.jsxs("div",{className:"mt-2 flex items-center space-x-2 text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Assigned to:"}),e.jsx("span",{className:"font-medium text-slate-700",children:a.assignedTo?.firstName})]})]}),e.jsx("div",{className:"flex space-x-2",children:e.jsx("button",{onClick:()=>o(null),className:"rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600",children:e.jsx(Y,{className:"text-lg"})})})]})}),e.jsxs("div",{className:"flex flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsx("div",{className:"flex min-h-full flex-col-reverse space-y-4 space-y-reverse",children:a.messages&&a.messages.length>0?[...a.messages].reverse().map((s,t)=>{const n=s?.sender?.role==="admin",h=n?"Admin":v(s.sender||a.createdBy);return e.jsxs("div",{className:`rounded-lg p-4 ${n?"border border-[#0b8263]/20 bg-[#0b8263]/10":"bg-slate-50"}`,children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`flex h-8 w-8 items-center justify-center rounded-full ${n?"bg-[#0b8263]":"bg-slate-300"}`,children:n?e.jsx("span",{className:"text-sm font-medium text-white",children:"A"}):e.jsx(f,{className:"text-slate-600"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-700",children:h}),e.jsx("span",{className:"ml-2 text-xs text-slate-500",children:n?"(Admin)":`(${a.createdByModel})`})]})]}),e.jsx("span",{className:"text-xs text-slate-500",children:p(s.createdAt)})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap text-slate-700",children:s.message})]},s._id||t)}):e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(g,{className:"mx-auto mb-2 text-3xl text-slate-400"}),e.jsx("p",{className:"text-slate-500",children:"No messages yet"})]})})}),e.jsx("div",{ref:N})]}),a.status!=="closed"&&e.jsx("div",{className:"border-t border-slate-200 bg-white p-4",children:e.jsxs("form",{onSubmit:q,className:"space-y-3",children:[e.jsx("textarea",{value:x,onChange:s=>B(s.target.value),placeholder:"Type your response...",rows:"3",disabled:b,className:"w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none disabled:opacity-50"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-xs text-slate-500",children:"Replying as Admin"}),e.jsxs("button",{type:"submit",disabled:!x.trim()||b,className:"flex items-center space-x-2 rounded-lg bg-[#0b8263] px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-emerald-700 disabled:opacity-50",children:[e.jsx(Z,{className:"text-sm"}),e.jsx("span",{children:b?"Sending...":"Send Response"})]})]})]})})]})]}):e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-8 text-center shadow-sm",children:[e.jsx(g,{className:"mx-auto mb-3 text-4xl text-slate-400"}),e.jsx("h3",{className:"mb-2 text-lg font-semibold text-slate-700",children:"No Ticket Selected"}),e.jsx("p",{className:"text-slate-500",children:"Select a ticket from the list to view details and respond"})]})})]})]})})})};export{pe as default};
