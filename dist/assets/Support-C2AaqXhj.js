import{a as n,c as H,s as J,b as v,y as d,j as e}from"./index-DY_vMsxx.js";import{g as K,h,i as g,e as W,j as Y,k as Z,l as ee,f as se,m as te}from"./index-BtOJAcAF.js";import{B as ae}from"./App-CsXzvAq8.js";import"./iconBase-BnsnIT86.js";const oe=()=>{const[w,i]=n.useState([]),[f,S]=n.useState(!1),[a,o]=n.useState(null),[L,T]=n.useState(!1),[x,C]=n.useState(""),[b,F]=n.useState(!1),[re,le]=n.useState(!1),M=H(),j=useRef(null),A=useNavigate(),[_,D]=n.useState(""),[r,E]=n.useState({status:"",type:"",search:""}),[c,R]=n.useState({currentPage:1,totalPages:1,totalTickets:0,hasNext:!1,hasPrev:!1});n.useEffect(()=>{M(J(5))},[M]);const V=(s=1)=>{const t={page:s,limit:20};return r.status&&(t.status=r.status),r.type&&(t.type=r.type),r.search&&(t.search=r.search),t},m=useCallback(async(s=1)=>{S(!0);try{const t=V(s);console.log(t,"params");const l=await v.getAllSupportTickets(t);l.data.success?(i(l.data.tickets||[]),R(l.data.pagination||{currentPage:1,totalPages:1,totalTickets:0,hasNext:!1,hasPrev:!1})):(d.error(l.data.message||"Failed to fetch tickets"),i([]))}catch(t){console.error("Failed to fetch tickets:",t),i([])}finally{S(!1)}},[r.status,r.type,_]),B=useCallback(async s=>{if(s){T(!0);try{const t=await v.getTicketById(s);t.data.success?(o(t.data.ticket),i(l=>l.map(p=>p._id===s?t.data.ticket:p))):d.error(t.data.message||"Failed to load ticket details")}catch(t){console.error("Failed to fetch ticket details:",t),d.error(t.response?.data?.error||"Failed to load ticket details")}finally{T(!1)}}},[]);n.useEffect(()=>{m(1)},[r.status,r.type,m]),n.useEffect(()=>{const s=setTimeout(()=>{D(r.search)},1e3);return()=>clearTimeout(s)},[r.search]);const N=(s,t)=>{E(l=>({...l,[s]:t})),s==="search"&&o(null)},I=s=>{s.preventDefault()},q=async s=>{if(s.preventDefault(),!(!x.trim()||!a)){F(!0);try{const t=await v.addMessageToTicket(a._id,{message:x.trim()});t.data.success?(await B(a._id),C(""),d.success("Message sent successfully!"),setTimeout(()=>{j.current?.scrollIntoView({behavior:"smooth"})},100)):d.error(t.data.message||"Failed to send message")}catch(t){console.error("Failed to send message:",t),d.error(t.response?.data?.error||"Failed to send message")}finally{F(!1)}}},O=s=>{o(s),B(s._id)},Q=s=>{switch(s){case"open":return e.jsx(se,{className:"text-orange-500"});case"in-progress":return e.jsx(ee,{className:"text-blue-500"});case"closed":return e.jsx(Z,{className:"text-green-500"});default:return e.jsx(h,{className:"text-gray-500"})}},P=s=>{switch(s){case"open":return"bg-orange-100 text-orange-800 border-orange-200";case"in-progress":return"bg-blue-100 text-blue-800 border-blue-200";case"closed":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},U=s=>{switch(s){case"User":return e.jsx(te,{className:"text-purple-500"});case"Vendor":return e.jsx(FiShoppingBag,{className:"text-teal-500"});default:return e.jsx(g,{className:"text-gray-500"})}},X=s=>{switch(s){case"User":return"text-purple-600 bg-purple-50";case"Vendor":return"text-teal-600 bg-teal-50";default:return"text-gray-600 bg-gray-50"}},u=s=>s?new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",y=s=>s?typeof s=="string"?s:`${s.firstName||""} ${s.lastName||""}`.trim()||s.email||"Unknown User":"Unknown User",k=s=>!s||typeof s=="string"?"":s.email||"",z=s=>!s.messages||s.messages.length===0?s.createdAt:s.messages[s.messages.length-1].createdAt,$=s=>s.messages?s.messages.filter(t=>t.senderModel==="User"&&!t.isRead).length:0,G=s=>!s.messages||s.messages.length===0?"No messages":s.messages[s.messages.length-1].message||"No message content";return n.useEffect(()=>{a?.messages?.length&&j.current?.scrollIntoView({behavior:"smooth"})},[a?.messages]),e.jsx(RootLayout,{children:e.jsx("div",{className:"min-h-screen bg-white px-4 py-8 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"mx-auto max-w-7xl",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ae,{className:"text-4xl text-[#0b8263]"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-800",children:"Support Management"}),e.jsx("p",{className:"text-slate-600",children:"Manage and respond to user and vendor support tickets"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-[#0b8263]",children:c.totalTickets}),e.jsx("div",{className:"text-sm text-slate-500",children:"Total Tickets"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 lg:grid-cols-4",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-2",children:[e.jsx("div",{className:"rounded-lg border border-slate-200 bg-white p-4 shadow-sm",children:e.jsxs("div",{className:"flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4",children:[e.jsx("form",{onSubmit:I,className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute top-1/2 left-3 -translate-y-1/2 transform text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Search by subject or user...",value:r.search,onChange:s=>N("search",s.target.value),className:"w-full rounded-lg border border-slate-300 py-2 pr-4 pl-10 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none"})]})}),e.jsxs("select",{value:r.status,onChange:s=>N("status",s.target.value),className:"rounded-lg border border-slate-300 px-3 py-2 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in-progress",children:"In Progress"}),e.jsx("option",{value:"closed",children:"Closed"})]}),e.jsxs("select",{value:r.type,onChange:s=>N("type",s.target.value),className:"rounded-lg border border-slate-300 px-3 py-2 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none",children:[e.jsx("option",{value:"",children:"All Types"}),e.jsx("option",{value:"User",children:"User"}),e.jsx("option",{value:"Vendor",children:"Vendor"})]})]})}),e.jsx("div",{className:"space-y-3",children:f?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-b-2 border-[#0b8263]"}),e.jsx("p",{className:"mt-2 text-slate-600",children:"Loading tickets..."})]}):w.length===0?e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white py-12 text-center",children:[e.jsx(h,{className:"mx-auto mb-3 text-4xl text-slate-400"}),e.jsx("p",{className:"text-slate-600",children:"No tickets found"}),e.jsx("p",{className:"mt-1 text-sm text-slate-500",children:r.status||r.type||r.search?"Try changing your filters":"No support tickets yet"})]}):w.map(s=>e.jsx("div",{className:`cursor-pointer rounded-lg border bg-white p-4 shadow-sm transition-all hover:shadow-md ${a?._id===s._id?"border-[#0b8263] ring-2 ring-[#0b8263]":"border-slate-200"}`,onClick:()=>O(s),children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"mb-2 flex items-center space-x-2",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[Q(s.status),e.jsx("span",{className:`rounded-full border px-2 py-1 text-xs font-medium ${P(s.status)}`,children:s.status.replace("-"," ")})]}),e.jsxs("span",{className:`flex items-center space-x-1 rounded-full px-2 py-1 text-xs font-medium ${X(s.createdByModel)}`,children:[U(s.createdByModel),e.jsx("span",{children:s.createdByModel})]}),$(s)>0&&e.jsxs("span",{className:"rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800",children:[$(s)," new"]})]}),e.jsx("h3",{className:"mb-1 truncate font-semibold text-slate-800",children:s.subject}),e.jsx("p",{className:"text-xs text-gray-500",children:s.customSupportId}),e.jsxs("div",{className:"mb-2 flex items-center space-x-2 text-sm text-slate-600",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(g,{className:"text-slate-400"}),e.jsx("span",{onClick:t=>{t.stopPropagation(),s.createdByModel==="User"?A(`/user/${s.createdBy._id}`):A(`/vendor/${s.createdBy._id}`)},className:"hover:cursor-pointer hover:text-blue-500",children:y(s.createdBy)})]}),e.jsx("span",{children:"•"}),e.jsx("span",{children:k(s.createdBy)})]}),e.jsx("p",{className:"mb-2 line-clamp-2 text-sm text-slate-600",children:G(s)}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500",children:[e.jsxs("span",{children:[s.messages?.length||0," messages"]}),e.jsxs("span",{children:["Last: ",u(z(s))]})]})]})})},s._id))}),c.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between border-t border-slate-200 pt-4",children:[e.jsx("button",{onClick:()=>m(c.currentPage-1),disabled:!c.hasPrev||f,className:"rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 disabled:opacity-50",children:"Previous"}),e.jsxs("span",{className:"text-sm text-slate-600",children:["Page ",c.currentPage," of ",c.totalPages]}),e.jsx("button",{onClick:()=>m(c.currentPage+1),disabled:!c.hasNext||f,className:"rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-700 disabled:opacity-50",children:"Next"})]})]}),e.jsx("div",{className:"lg:col-span-2",children:L?e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-8 text-center shadow-sm",children:[e.jsx("div",{className:"mx-auto h-8 w-8 animate-spin rounded-full border-b-2 border-[#0b8263]"}),e.jsx("p",{className:"mt-4 text-slate-600",children:"Loading ticket details..."})]}):a?e.jsxs("div",{className:"sticky top-4 rounded-lg border border-slate-200 bg-white shadow-sm",children:[e.jsx("div",{className:"border-b border-slate-200 p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-800",children:a.subject}),e.jsx("span",{className:`rounded-full border px-2 py-1 text-xs font-medium ${P(a.status)}`,children:a.status.replace("-"," ")})]}),e.jsxs("div",{className:"mt-2 flex items-center space-x-4 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[U(a.createdByModel),e.jsxs("span",{children:[a.createdByModel," Ticket"]})]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Created: ",u(a.createdAt)]}),a.closedAt&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Closed: ",u(a.closedAt)]})]})]}),e.jsx("div",{className:"mt-2 flex items-center space-x-2 text-sm",children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(g,{className:"text-slate-400"}),e.jsx("span",{className:"font-medium text-slate-700 hover:cursor-pointer",children:y(a.createdBy)}),e.jsxs("span",{className:"text-slate-500",children:["(",k(a.createdBy),")"]})]})}),a.assignedTo&&e.jsxs("div",{className:"mt-2 flex items-center space-x-2 text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Assigned to:"}),e.jsx("span",{className:"font-medium text-slate-700",children:a.assignedTo?.firstName})]})]}),e.jsx("div",{className:"flex space-x-2",children:e.jsx("button",{onClick:()=>o(null),className:"rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600",children:e.jsx(W,{className:"text-lg"})})})]})}),e.jsxs("div",{className:"max-h-[500px] space-y-4 overflow-y-auto p-4",children:[a.messages&&a.messages.length>0?a.messages.map((s,t)=>{const l=s?.sender.role==="admin",p=l?"Admin":y(s.sender||a.createdBy);return e.jsxs("div",{className:`rounded-lg p-4 ${l?"border border-[#0b8263]/20 bg-[#0b8263]/10":"bg-slate-50"}`,children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`flex h-8 w-8 items-center justify-center rounded-full ${l?"bg-[#0b8263]":"bg-slate-300"}`,children:l?e.jsx("span",{className:"text-sm font-medium text-white",children:"A"}):e.jsx(g,{className:"text-slate-600"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-slate-700",children:p}),e.jsx("span",{className:"ml-2 text-xs text-slate-500",children:l?"(Admin)":`(${a.createdByModel})`})]})]}),e.jsx("span",{className:"text-xs text-slate-500",children:u(s.createdAt)})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap text-slate-700",children:s.message})]},s._id||t)}):e.jsxs("div",{className:"py-8 text-center",children:[e.jsx(h,{className:"mx-auto mb-2 text-3xl text-slate-400"}),e.jsx("p",{className:"text-slate-500",children:"No messages yet"})]}),e.jsx("div",{ref:j})]}),a.status!=="closed"&&e.jsx("div",{className:"border-t border-slate-200 p-4",children:e.jsxs("form",{onSubmit:q,className:"space-y-3",children:[e.jsx("textarea",{value:x,onChange:s=>C(s.target.value),placeholder:"Type your response...",rows:"3",disabled:b,className:"w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-transparent focus:ring-2 focus:ring-[#0b8263] focus:outline-none disabled:opacity-50"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-xs text-slate-500",children:"Replying as Admin"}),e.jsxs("button",{type:"submit",disabled:!x.trim()||b,className:"flex items-center space-x-2 rounded-lg bg-[#0b8263] px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-emerald-700 disabled:opacity-50",children:[e.jsx(Y,{className:"text-sm"}),e.jsx("span",{children:b?"Sending...":"Send Response"})]})]})]})})]}):e.jsxs("div",{className:"rounded-lg border border-slate-200 bg-white p-8 text-center shadow-sm",children:[e.jsx(h,{className:"mx-auto mb-3 text-4xl text-slate-400"}),e.jsx("h3",{className:"mb-2 text-lg font-semibold text-slate-700",children:"No Ticket Selected"}),e.jsx("p",{className:"text-slate-500",children:"Select a ticket from the list to view details and respond"})]})})]})]})})})};export{oe as default};
